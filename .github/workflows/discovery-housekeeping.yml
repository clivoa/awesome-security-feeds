name: Discovery PR housekeeping

on:
  pull_request:
    types: [closed]
    # opcional: limita a PRs que tocam a pasta de candidates
    paths:
      - "feeds/_candidates/**"
      - "data/discovery/candidates/**"

jobs:
  cleanup_after_merge:
    if: >
      github.event.pull_request.merged == true
      && contains(join(github.event.pull_request.labels.*.name, ','), 'discovery')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout dev
        uses: actions/checkout@v4

      - name: Remove remaining candidates + evidence
        shell: bash
        run: |
          set -euo pipefail

          CAND_DIR="feeds/_candidates"
          JSON_DIR="data/discovery/candidates"

          # Se existirem, remove tudo (staging não é permanente)
          if [ -d "$CAND_DIR" ]; then
            echo "Cleaning $CAND_DIR"
            rm -f "$CAND_DIR"/*.yaml || true
          fi

          if [ -d "$JSON_DIR" ]; then
            echo "Cleaning $JSON_DIR"
            rm -f "$JSON_DIR"/*.json || true
          fi

          # Remove diretórios vazios (opcional)
          rmdir "$CAND_DIR" 2>/dev/null || true
          rmdir "$JSON_DIR" 2>/dev/null || true
          rmdir "data/discovery" 2>/dev/null || true

      - name: Commit cleanup (if needed)
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "$(git status --porcelain)" ]; then
            echo "No housekeeping changes."
            exit 0
          fi

          git config user.name "discovery-housekeeping"
          git config user.email "discovery-housekeeping@users.noreply.github.com"

          git add -A
          git commit -m "chore(discovery): cleanup candidates after merge"
          git push origin dev
