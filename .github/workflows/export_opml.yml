name: Export OPML feeds
on:
  schedule:
    - cron: "30 3 * * *"   # diário 03:30 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      # 1) Promove candidates -> feeds/*.yaml (dedupe) e limpa feeds/_candidates/*
      #    2) Já gera o OPML FULL no mesmo passo
      - name: Promote candidates + Export FULL OPML
        run: |
          python scripts/export_opml.py \
            --feeds-dir feeds \
            --promote-candidates \
            --cleanup-candidates \
            --cleanup-discovery \
            --out data/sec_feeds_full.xml \
            --title "Security Feeds (Full)" \
            --status all


      # Export ACTIVE (sem promote; candidates já foram processados/limpos acima)
      - name: Export ACTIVE OPML
        run: |
          python scripts/export_opml.py \
            --out data/sec_feeds_active.xml \
            --title "Security Feeds (Active only)" \
            --status active

      - name: Commit changes (if any)
        run: |
          set -euo pipefail

          # pega alterações em data, feeds, e remoções em feeds/_candidates
          git status --porcelain

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes detected."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # add incluindo deletes
          git add -A data feeds

          git commit -m "chore(export): update OPML + promote candidates"
          git push
